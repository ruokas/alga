<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zoninio Koeficiento Skaičiuoklė (V2 – triažas + apkrova)</title>
  <script>
    (() => {
      try {
        const root = document.documentElement;
        const prefersLight =
          window.matchMedia &&
          window.matchMedia('(prefers-color-scheme: light)').matches;
        const saved = localStorage.getItem('ED_THEME');
        if (prefersLight && !saved) {
          root.classList.add('light-theme');
        } else if (saved === 'light') {
          root.classList.add('light-theme');
        }
      } catch (e) {
        // localStorage might be unavailable
      }
    })();
  </script>
  <link rel="stylesheet" href="styles.css">
  </head>
<body>
  <div class="container">
    <div class="title">
      <h1>Zoninio Koeficiento Skaičiuoklė</h1>
      <label class="switch">
        <input id="themeToggle" type="checkbox" />
        <span>Šviesi tema</span>
      </label>
      <button id="budgetPlanner" type="button">Biudžeto planavimas</button>
    </div>

    <div class="grid grid-2 calc-grid">
      <div class="card">
        <h2>Įvestis</h2>
        <nav class="nav-sections">
          <a href="game.html">Mini žaidimas</a>
          <a href="#shift-section">Pamainos parametrai</a>
          <a href="#patients-section">Pacientų pasiskirstymas</a>
          <a href="#staff-section">Darbuotojai</a>
          <a href="#advanced-section">Išplėstinės parinktys</a>
        </nav>
        <div class="progress"><div id="stepProgressBar" class="bar"></div></div>
        <div class="step active" data-step="1">
        <fieldset id="shift-section" class="section">
          <legend>Pamainos parametrai</legend>
          <div class="row">
            <div>
              <label for="date">Data</label>
              <input id="date" type="date" />
            </div>
            <div>
              <label for="shift">Pamaina</label>
              <select id="shift">
                <option value="D">Dieninė</option>
                <option value="N">Naktinė</option>
                <option value="P">Paros</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div>
              <label for="zone">Zona</label>
              <div class="row zone-row">
                <select id="zone"></select>
                <button id="manageZones" type="button">Tvarkyti zonas</button>
              </div>
            </div>
            <div>
              <label for="zoneCapacity">Zonos talpa (pac./pam.)</label>
              <input id="zoneCapacity" type="number" min="0" step="1" placeholder="pvz. 16" />
              <div class="help">Keičiant zoną/pamainą įstatoma numatytoji talpa (galite perrašyti).</div>
              <!-- formerly id="capacity" representing C -->
            </div>
          </div>
          <div class="row">
            <div>
              <label for="shiftHours">Pamainos trukmė (val.)</label>
              <input id="shiftHours" type="number" min="0" step="0.5" value="12" />
            </div>
            <div>
              <label for="monthHours">Mėnesio valandos</label>
              <input id="monthHours" type="number" min="0" step="0.5" value="0" />
            </div>
          </div>
        </fieldset>
        <div class="step-nav actions">
          <button type="button" class="next-step">Toliau</button>
        </div>
        </div>

        <div class="step" data-step="2">
        <fieldset id="patients-section" class="section">
          <legend>Pacientų pasiskirstymas</legend>
          <div class="row">
            <div>
              <label for="patientCount">Pacientų skaičius (zonoje per pamainą)</label>
              <input id="patientCount" type="number" min="0" step="1" value="0" />
              <!-- formerly id="N" -->
            </div>
          </div>
          <div class="switch-block">
            <label class="switch">
              <input id="linkPatientCount" type="checkbox" checked />
              <span>Naudoti Pacientų skaičių = ESI1+ESI2+ESI3+ESI4+ESI5</span>
              <!-- formerly id="linkN" -->
            </label>
          </div>
          <div class="row-3">
            <div>
              <label for="esi1">ESI-1</label>
              <input id="esi1" type="number" min="0" step="1" value="0" />
            </div>
            <div>
              <label for="esi2">ESI-2</label>
              <input id="esi2" type="number" min="0" step="1" value="0" />
            </div>
            <div>
              <label for="esi3">ESI-3</label>
              <input id="esi3" type="number" min="0" step="1" value="0" />
            </div>
          </div>
          <div class="row-3">
            <div>
              <label for="esi4">ESI-4</label>
              <input id="esi4" type="number" min="0" step="1" value="0" />
            </div>
            <div>
              <label for="esi5">ESI-5</label>
              <input id="esi5" type="number" min="0" step="1" value="0" />
            </div>
            <div>
              <label>&nbsp;</label>
              <div class="help">Jei nėra triažo – palikite visur nulį.</div>
            </div>
          </div>
          <div class="actions">
            <button id="simulateEsi">Simuliuoti pamainą</button>
          </div>
        </fieldset>
        <div class="step-nav actions">
          <button type="button" class="back-step">Atgal</button>
          <button type="button" class="next-step">Toliau</button>
        </div>
        </div>

        <div class="step" data-step="3">
        <fieldset id="staff-section" class="section">
          <legend>Darbuotojai</legend>

          <div class="staff-group">
            <h3>Gydytojas</h3>
            <div class="row">
              <div>
                <label for="baseRateDoc">Bazinis tarifas (€/val.)</label>
                <input id="baseRateDoc" type="number" min="0" step="0.01" value="0" placeholder="pvz. 25.00" />
              </div>
            </div>
          </div>

          <div class="staff-group">
            <h3>Slaugytojas</h3>
            <div class="row">
              <div>
                <label for="baseRateNurse">Bazinis tarifas (€/val.)</label>
                <input id="baseRateNurse" type="number" min="0" step="0.01" value="0" placeholder="pvz. 14.00" />
              </div>
            </div>
          </div>

          <div class="staff-group">
            <h3>Padėjėjas</h3>
            <div class="row">
              <div>
                <label for="baseRateAssist">Bazinis tarifas (€/val.)</label>
                <input id="baseRateAssist" type="number" min="0" step="0.01" value="0" placeholder="pvz. 9.00" />
              </div>
            </div>
          </div>

          <div id="extraRoles"></div>
          <div class="actions">
            <button id="addRateRole" type="button">+ Pridėti rolę</button>
            <button id="saveRateTemplate">Įsiminti darbuotojų šabloną</button>
            <button id="loadRateTemplate">Užkrauti šabloną</button>
          </div>
          <div class="help">Darbuotojų šablonas saugomas vietoje (localStorage).</div>
        </fieldset>
        <div class="step-nav actions">
          <button type="button" class="back-step">Atgal</button>
          <button type="button" class="next-step">Toliau</button>
        </div>
        </div>

        <div class="step" data-step="4">
        <fieldset id="advanced-section" class="section">
          <legend>Išplėstinės parinktys</legend>
          <div class="row">
            <div>
              <label for="formula">Skaičiavimo formulė</label>
              <select id="formula">
                <option value="legacy">Triažas + apkrova</option>
                <option value="ladder">Laiptelinė</option>
              </select>
            </div>
            <div>
              <label for="maxCoefficient">Maksimalus koeficientas</label>
              <input id="maxCoefficient" type="number" min="1" max="2" step="0.01" value="1.30" />
              <!-- formerly id="kmax" -->
            </div>
          </div>
          <div id="formulaInfo"></div>
          <div class="row-3">
            <div>
              <label for="minDoctor">Min. gydytojų skaičius</label>
              <input id="minDoctor" type="number" min="0" step="1" value="0" />
            </div>
            <div>
              <label for="minNurse">Min. slaugytojų skaičius</label>
              <input id="minNurse" type="number" min="0" step="1" value="0" />
            </div>
            <div>
              <label for="minAssistant">Min. padėjėjų skaičius</label>
              <input id="minAssistant" type="number" min="0" step="1" value="0" />
            </div>
          </div>
        </fieldset>

        <div class="actions">
          <button class="primary" id="reset">Išvalyti</button>
          <button id="copy">Kopijuoti rezultatą (JSON)</button>
          <button id="downloadCsv">Atsisiųsti CSV</button>
          <button id="downloadPdf">Atsisiųsti PDF</button>
        </div>
        <div class="step-nav actions">
          <button type="button" class="back-step">Atgal</button>
        </div>
        </div>
      </div>
      <div class="resizer"></div>
      <div class="card">
        <h2>Rezultatai</h2>
        <div class="kpi">
          <div class="item">
            <div class="label">Santykis Pacientų skaičius/Zonos talpa</div>
            <div class="val" id="ratio">0.00</div>
            <div class="chart-wrap">
              <canvas id="ratioChart"></canvas>
            </div>
            <div class="help">Apkrovos intervalas lemia V<sub>priedas</sub></div>
          </div>
          <div class="item">
            <div class="label">Aukštos skubos dalis S = (ESI1+ESI2)/Pacientų skaičius</div>
            <div class="val" id="sShare">0.00</div>
            <div class="chart-wrap">
              <canvas id="sChart"></canvas>
            </div>
            <div class="help">Lemia A<sub>priedas</sub></div>
          </div>
          <div class="item pay-chart">
            <div class="label">Tarifų grafikas</div>
            <div class="chart-wrap">
              <canvas id="payChart"></canvas>
            </div>
          </div>
          </div>

        <table class="table">
          <thead>
            <tr><th>Komponentas</th><th>Reikšmė</th><th>Pastaba</th></tr>
          </thead>
          <tbody>
            <tr>
              <td>V<sub>priedas</sub> (apkrova)</td>
              <td id="vBonus">+0.00</td>
              <td>
                ≤0.8 → 0.00 · (0.8–1.0] → 0.05 · (1.0–1.25] → 0.10 · &gt;1.25 → 0.15
              </td>
            </tr>
            <tr>
              <td>A<sub>priedas</sub> (triažas)</td>
              <td id="aBonus">+0.00</td>
              <td>
                ≤10% → 0.00 · (10–20]% → 0.05 · (20–30]% → 0.10 · &gt;30% → 0.15
              </td>
            </tr>
            <tr>
              <td>Maksimalus koeficientas</td>
              <td id="maxCoefficientCell">1.30</td>
              <td>Galinio koeficiento riba</td>
            </tr>
            <tr>
              <td class="accent">K<sub>zona</sub></td>
              <td class="accent" id="kZona">1.00</td>
              <td>min(1 + V + A, Maksimalus koeficientas)</td>
            </tr>
          </tbody>
        </table>

        <h2 class="role-heading">Darbuotojai pagal rolę</h2>
          <table class="table">
            <thead>
              <tr><th>Rolė</th><th>Bazė (€/val.)</th><th>Koef. K<sub>zona</sub></th><th>Galutinis (€/val.)</th><th>Pam. alga (€/pam.)</th><th>Mėn. alga (€/mėn.)</th><th>Improvement</th></tr>
            </thead>
            <tbody id="rateTbody">
              <tr><td>Gydytojas</td><td id="baseDocCell">€0,00</td><td id="kDocCell">1,00</td><td class="accent" id="finalDocCell">€0,00</td><td id="shiftDocCell">€0,00</td><td id="monthDocCell">€0,00</td><td id="deltaDocCell">€0,00 / €0,00</td></tr>
              <tr><td>Slaugytojas</td><td id="baseNurseCell">€0,00</td><td id="kNurseCell">1,00</td><td class="accent" id="finalNurseCell">€0,00</td><td id="shiftNurseCell">€0,00</td><td id="monthNurseCell">€0,00</td><td id="deltaNurseCell">€0,00 / €0,00</td></tr>
              <tr><td>Padėjėjas</td><td id="baseAssistCell">€0,00</td><td id="kAssistCell">1,00</td><td class="accent" id="finalAssistCell">€0,00</td><td id="shiftAssistCell">€0,00</td><td id="monthAssistCell">€0,00</td><td id="deltaAssistCell">€0,00 / €0,00</td></tr>
            </tbody>
          </table>
        <div class="footer">
          Patarimas: jei dažnai pasiekiate lubas, padidinkite zonos talpą arba sumažinkite priedų laiptelius.
        </div>
      </div>
    </div>
  </div>

  <!-- ZONŲ TVARKYMO MODALAS (drag&drop + grupės) -->
  <div class="modal" id="zoneModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="dialog">
      <h3>Zonų tvarkymas</h3>
      <div class="help">Pridėkite, redaguokite, <strong>rikiuokite (drag&drop)</strong> ir grupuokite zonas. Pakeitimai saugomi šiame įrenginyje (<em>localStorage</em>).</div>
      <div class="toolbar">
        <button id="addZone" class="icon-btn">+ Pridėti zoną</button>
        <div class="spacer"></div>
        <button id="defaultsZones" class="warn">Numatytosios zonos</button>
        <button id="closeZoneModal">Uždaryti</button>
        <button id="saveZonesBtn" class="primary">Išsaugoti</button>
      </div>
      <table class="table modal-table">
        <thead>
          <tr>
            <th class="w-4"></th>
            <th class="w-28">Pavadinimas</th>
            <th class="w-14">Kodas</th>
            <th class="w-14">Grupė</th>
            <th class="w-14">Talpa D</th>
            <th class="w-14">Talpa N</th>
            <th class="w-14">Talpa P</th>
            <th class="w-12">Šalinti</th>
          </tr>
        </thead>
        <tbody id="zoneTbody"></tbody>
      </table>
      <div class="help small">Pastaba: <strong>Kodas</strong> turi būti unikalus (pvz., A, B, FAST). Grupę galite įvesti savo (pvz., „Suaugusiųjų“, „Vaikų“).</div>
    </div>
  </div>
    <!-- Chart.js v4.4.9 pinned to avoid unexpected breaking changes -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.9?v=4.4.9"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="csv.js" defer></script>
    <script src="pdf.js" defer></script>
    <script src="app.js" defer></script>
    <script type="module" src="ui.js"></script>
</body>
</html>
